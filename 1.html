<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <title>Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Sofia+Sans+Condensed:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
    <script src="refresh_force.js"></script>
    <script src="no_select.js"></script>
    <style>  
        *{   font-family: "Sofia Sans Condensed", sans-serif;
    </style>  
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            min-height: 100vh;
            color: white;
        }
        
        .logo {
            height: 3em;
            width: auto;
        }
        
        #header {
            width: 99%;
            background: black;
            position: fixed;
            top: 2px;
            padding: 10px;
            left: 2px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            border: 1px solid #333;
            overflow-x: auto;
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            padding: 5px 15px;
            border: 1px solid #6ab8ff;
            border-radius: 5px;
            background: rgba(106, 184, 255, 0.1);
        }
        
        main {
            margin-top: 6em;
            padding: 5px;
        }
        
        .admin-container {
            background: #111;
            border-radius: 10px;
            padding: 0;
            margin: 0 auto;
            width: 100%;
            border: 1px solid #333;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #6ab8ff;
            text-shadow: 0 0 10px rgba(106, 184, 255, 0.3);
        }
        
        .login-section {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: #111;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .login-section h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #6ab8ff;
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border-radius: 5px;
            border: 1px solid #333;
            background: #222;
            color: white;
            font-size: 16px;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 55px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }
        
        .password-toggle:hover {
            color: #ccc;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: #6ab8ff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #4a9eff;
        }
        
        .logout-btn {
            background: #dc3545;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: block;
        }
        
        .success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
            display: block;
        }
        
        .admin-panel {
            display: none;
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            overflow-y: auto;
        }
        
        .tab-btn {
            padding: 30em;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            color: #6ab8ff;
        }
        
        .tab-btn.active {
            color: #6ab8ff;
            border-bottom-color: #6ab8ff;
            background: rgba(106, 184, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            background: #222;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
            min-height: 400px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background: #333;
            color: #6ab8ff;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(106, 184, 255, 0.05);
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
            transition: opacity 0.3s;
        }
        
        .action-btn:hover {
            opacity: 0.8;
        }
        
        .edit-btn {
            background: #6ab8ff;
            color: white;
        }
        
        .activate-btn {
            background: #28a745;
            color: white;
        }
        
        .suspend-btn {
            background: #ffc107;
            color: black;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #111;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #333;
            position: relative;
            height: 70%;
            overflow-y: auto;
        }
        
        .modal h3 {
            color: #6ab8ff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #333;
            background: #222;
            color: white;
            font-size: 16px;
        }
        
        .modal-password-toggle {
            position: absolute;
            right: 42px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }
        
        .modal-btn {
            width: 90%;
            padding: 5px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
            background: #6ab8ff;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .modal-btn:hover {
            background: #4a9eff;
        }
        
        .modal-btn.secondary {
            background: #333;
        }
        
        .modal-btn.secondary:hover {
            background: #444;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ccc;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: white;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #333;
            background: #222;
            color: white;
            font-size: 16px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .status-inactive {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .status-pending {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);

        }
        
        .status-suspended {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(106, 184, 255, 0.3);
            border-top: 4px solid #6ab8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #444;
        }
        
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
        }
        
        .refresh-btn:hover {
            background: #218838;
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .action-btn {
                margin: 1px;
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .data-count {
            color: #6ab8ff;
            font-weight: bold;
        }
        #total-balance{
            color: #6ab8ff;
            font-size: 28px;
            font-weight: bold;
            overflow-x: auto;
            width: 60%;
        }
        
        /* Profile picture styles */
        .profile-pic-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6ab8ff;
        }
        
        /* User details modal styles */
        .user-details-modal .modal-content {
            height: 90%;
            max-width: 800px;
            overflow-y: auto;
        }
        
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .user-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #6ab8ff;
        }
        
        .user-profile-info {
            flex: 1;
        }
        
        .user-profile-info h3 {
            color: #6ab8ff;
            margin-bottom: 10px;
        }
        
        .user-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-card {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .detail-card h4 {
            color: #6ab8ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-label {
            color: #ccc;
            font-weight: bold;
        }
        
        .detail-value {
            color: white;
            text-align: right;
        }
        
        .referrals-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .referral-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(106, 184, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .referral-pic {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        
        .danger-zone {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .danger-zone h4 {
            color: #dc3545;
            margin-bottom: 15px;
        }
        
        .country-flag {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        /* Long press styles */
        .long-press-active {
            background: rgba(106, 184, 255, 0.2) !important;
            border: 1px solid #6ab8ff !important;
        }
        
        .user-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-row:active {
            background: rgba(106, 184, 255, 0.1);
        }
        
        /* Transaction stats */
        .transaction-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(106, 184, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(106, 184, 255, 0.3);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #6ab8ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #ccc;
            font-size: 0.9em;
        }
        
        /* Balance summary */
        .balance-summary {
            background: rgba(40, 167, 69, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .balance-summary h4 {
            color: #28a745;
            margin-bottom: 15px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        /* Dropdown Styles */
        .dropdown {
            position: fixed;
            right: 0;
            display: inline-block;
        }
        
        .dropdown-toggle {
            background: none;
            color: white;
            padding: 10px 2p;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 2em;
        }
        
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 120%;
            background: black;
            min-width: 200px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            margin-top: 5px;
            border: 1px solid #404040;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: white;
            transition: all 0.5s;
            border-bottom: 1px solid #404040;
        }
        
        .dropdown-menu a sup {
            background: green;
            padding: 0 5px;
            border-radius: 50%;
        }
        
        .dropdown-menu a i {
            padding-right: 30px;
        }
        
        .show {
            display: block;
        }
        
        .comment-content-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .comment-content-full {
            max-width: 400px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .comment-filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            overflow-x: auto;
        }
        
        .comment-filter-btn {
            padding: 1px 20px;
            background: #333;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
            min-width: 30%;
        }
        
        .comment-filter-btn.active {
            background: #6ab8ff;
            color: white;
            border-color: #6ab8ff;
        }
        
        .comment-stats {
            display: none;
        }
        
        .comment-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .bulk-actions {
           display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        
        .bulk-btn {
            padding: 2px 20px;
            border: none;
            border-radius: 5px;
            width: 100%;
            font-weight: bold;
            min-width: 30%;
        }
        
        .bulk-select-btn {
            background: #6ab8ff;
            color: white;
            display: flex;
            flex-wrap: nowrap;
        }
        
        .bulk-approve-btn {
            background: #28a745;
            color: white;
        }
        
        .bulk-reject-btn {
            background: #ffc107;
            color: black;
        }
        
        .bulk-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .comment-checkbox {
            margin-right: 10px;
        }
        
        .comment-row.selected {
            background: rgba(106, 184, 255, 0.15);
        }
        
        .modal-content.large {
            max-width: 800px;
            height: 85%;
        }
        
        .comment-details {
            max-height: 400px;
            overflow-y: auto;
            padding: 3px;
            background: #222;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .comment-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .meta-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
        }
        
        .meta-label {
            color: #6ab8ff;
            font-size: 0.9em;
        }
        
        .meta-value {
            color: white;
            font-weight: bold;
        }
        .toflow{
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <img src="logo.png" class="logo"><div class="value" id="total-balance">$0.00</div>
<div class="dropdown">
  <button class="dropdown-toggle">
      <i class="fas fa-ellipsis-v"></i>
  </button>
  <div class="dropdown-menu">
    <a><i class="fas fa-globe"></i> Users <sup id="total-users"></sup></a>
    <a><i class="fas fa-star"></i> Active Users <sup id="active-users"></sup></a>
    <a><i class="fas fa-hand-holding-usd"></i> Withdrawals <sup id="pending-withdrawals"></sup></a>
    <a><i class="fas fa-comments"></i> Comments <sup id="pending-comments"></sup></a>
    <a onclick="loadAllData()"><i class="fas fa-undo-alt fa-rotate-45"></i> Refresh</a>
    <a onclick="showCreateTransactionModal()"><i class="fas fa-plus-circle"></i> Create Transaction</a>
    <a href="2.html"><i class="fas fa-edit"></i> Edit Daily Activities</a>
  <a onclick="logoutAdmin()"><i class="fas fa-sign-out"></i> Logout</a>
  </div>
</div>

<style>
.dropdown {
  position: fixed;
  right: 0;
  display: inline-block;
}

.dropdown-toggle {
  background: none;
  color: white;
  padding: 10px 2p;
  border: none;
  cursor: pointer;
  border-radius: 4px;
  font-size: 2em;
}

.dropdown-menu {
  position: absolute;
  right: 0;
  top: 120%;
  background: black;
  min-width: 200px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
  margin-top: 5px;
  border: 1px solid #404040;
}

.dropdown-menu a {
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  color: white;
  transition: all 0.5s;
  border-bottom: 1px solid #404040;
}

.dropdown-menu a sup{
background: green;
padding: 0 5px;
border-radius: 50%;
 }
.dropdown-menu a i{
    padding-right: 30px;
}
.show {
  display: block;
}
</style>

<script>
const dropdown = document.querySelector('.dropdown');
const toggle = document.querySelector('.dropdown-toggle');
const menu = document.querySelector('.dropdown-menu');

toggle.addEventListener('click', function(e) {
  e.stopPropagation();
  menu.classList.toggle('show');
});

// Close dropdown only when clicking outside
document.addEventListener('click', function(e) {
  if (!dropdown.contains(e.target)) {
    menu.classList.remove('show');
  }
});
</script>
</div>    
    <!-- Main Content -->
    <main>
        <div class="admin-container">
           <!-- Login Section -->
            <div id="login-section" class="login-section">
                <h2>Confirm Access</h2>
                <div id="login-message" class="message"></div>
                <div class="input-group">
                    <label>Access code</label>
                    <input type="password" id="admin-password" placeholder="mcm_101...." autocomplete="current-password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('admin-password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button class="login-btn" onclick="adminLogin()">
Go
                </button>
            </div>
            
            <!-- Admin Panel -->
            <div id="admin-panel" class="admin-panel">
                <!-- Tabs -->
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="showTab('users')">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="tab-btn" onclick="showTab('comments')">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="tab-btn" onclick="showTab('referrals')">
                        <i class="fas fa-user-friends"></i>
                    </button>
                    <button class="tab-btn" onclick="showTab('transactions')">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="tab-btn" onclick="showTab('withdrawals')">
                        <i class="fas fa-money-bill-wave"></i> 
                    </button>
                    <button class="tab-btn" onclick="showTab('investments')">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="tab-btn" onclick="showTab('settings')">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <!-- Search Box -->
                <div class="search-box">
                    <input type="text" id="search-input" class="search-input" placeholder=" Search users, emails, or IDs..." onkeyup="searchTable()">
                </div>
                
                <div id="users-tab" class="tab-content active">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab8ff; margin: 0;">User Management</h3>
                            <span id="users-count" style="color: #ccc;">Loading...</span>
                        </div>
<div class="toflow">                   <table id="users-table">
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Referral Code</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
                
                <!-- Comments Tab - NEW -->
                <div id="comments-tab" class="tab-content">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab8ff; margin: 0;">Comments</h3>
                            <span id="comments-count" style="color: #ccc;">Loading...</span>
                        </div>
<!-- should not be part of the page -->                        
                        <div class="comment-stats" id="comment-stats" hidden>
                            <div class="comment-stat-card">
                                <div class="comment-stat-value" id="total-comments-stat">0</div>
                                <div class="comment-stat-label">Total Comments</div>
                            </div>
                            <div class="comment-stat-card">
                                <div class="comment-stat-value" id="pending-comments-stat">0</div>
                                <div class="comment-stat-label">Pending Review</div>
                            </div>
                            <div class="comment-stat-card">
                                <div class="comment-stat-value" id="approved-comments-stat">0</div>
                                <div class="comment-stat-label">Approved</div>
                            </div>
                            <div class="comment-stat-card">
                                <div class="comment-stat-value" id="rejected-comments-stat">0</div>
                                <div class="comment-stat-label">Rejected</div>
                            </div>
                        </div>
                        
                        <!-- Filter Buttons -->
                        <div class="comment-filter-buttons">
                            <button class="comment-filter-btn active" onclick="filterComments('all')">All</button>
                            <button class="comment-filter-btn" onclick="filterComments('pending')">Pending</button>
                            <button class="comment-filter-btn" onclick="filterComments('approved')">Approved</button>
                            <button class="comment-filter-btn" onclick="filterComments('rejected')">Rejected</button>
                            <button class="comment-filter-btn" onclick="filterComments('public')">Public</button>
                            <button class="comment-filter-btn" onclick="filterComments('private')">Private</button>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="bulk-actions">
                            <button class="bulk-btn bulk-select-btn" onclick="selectAllComments()">
Select
                            </button>
                            <button class="bulk-btn bulk-approve-btn" onclick="bulkApproveComments()">
                         Approve                             </button>
                            <button class="bulk-btn bulk-reject-btn" onclick="bulkRejectComments()">
                         Reject       </button>
                            <button class="bulk-btn bulk-delete-btn" onclick="bulkDeleteComments()">
                         Delete
                            </button>
                        </div>
                        
<div id="comments-table-div" style="overflow-x: auto;">                  <table id="comments-table">
                            <thead>
                                <tr>
                                    <th width="30px"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()"></th>
                                    <th>User</th>
                                    <th>Comment</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Visibility</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="comments-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
                
                <!-- Referrals Tab -->
                <div id="referrals-tab" class="tab-content">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab8ff; margin: 0;">Pending Referrals</h3>
                            <span id="referrals-count" style="color: #ccc;">Loading...</span>
                        </div>
<div class="toflow">                 <table id="referrals-table">
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Referee</th>
                                    <th>Referrer</th>
                                    <th>Râ€¢Code</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                  </div>  </div>
                </div>
                
                <!-- Transactions Tab -->
                <div id="transactions-tab" class="tab-content">
                    <div class="table-container">
                        <h3 style="color: #6ab8ff; margin-bottom: 15px;">Transactions</h3>
     <div class="toflow"> <table id="transactions-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
                
                <!-- Withdrawals Tab -->
                <div id="withdrawals-tab" class="tab-content">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab8ff; margin: 0;">Withdrawal Requests</h3>
                            <span id="withdrawals-count" style="color: #ccc;">Loading...</span>
                        </div>
                        <div id="withdrawals-container">
                   <div class="toscroll">      <table id="withdrawals-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Wallet</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-tbody">
                                    <tr>
                                        <td colspan="7" style="text-align: center;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table> </div>
                        </div>
                    </div>
                </div>
                
                <!-- Investments Tab -->
                <div id="investments-tab" class="tab-content">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab8ff; margin: 0;">Investment Requests</h3>
                            <span id="investments-count" style="color: #ccc;">Loading...</span>
                        </div>
                        <div id="investments-container">
    <div class="toflow">                      <table id="investments-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Plan</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="investments-tbody">
                                    <tr>
                                        <td colspan="6" style="text-align: center;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table></div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="table-container">
                        <h3 style="color: #6ab8ff; margin-bottom: 20px;">System Settings</h3>
                        <div style="margin-bottom: 20px;">
                            <div class="input-group">
                                <label>Activation Fee ($)</label>
                                <input type="number" id="activation-fee" class="modal-input" value="50" min="0">
                            </div>
                            <div class="input-group">
                                <label>Minimum Deposit ($)</label>
                                <input type="number" id="min-deposit" class="modal-input" value="10" min="0">
                            </div>
                            <div class="input-group">
                                <label>Minimum Withdrawal ($)</label>
                                <input type="number" id="min-withdrawal" class="modal-input" value="10" min="0">
                            </div>
                            <div class="input-group">
                                <label>Withdrawal Fee (%)</label>
                                <input type="number" id="withdrawal-fee" class="modal-input" value="5" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Referral Bonus ($)</label>
                                <input type="number" id="referral-bonus" class="modal-input" value="10" min="0">
                            </div>
                            <div class="input-group">
                                <label>Daily Activity Earnings ($)</label>
                                <input type="number" id="daily-earnings" class="modal-input" value="0.10" min="0" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Starter Plan Min ($)</label>
                                <input type="number" id="starter-min" class="modal-input" value="50" min="0">
                            </div>
                            <div class="input-group">
                                <label>Starter Plan Returns (%)</label>
                                <input type="number" id="starter-returns" class="modal-input" value="15" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Premium Plan Min ($)</label>
                                <input type="number" id="premium-min" class="modal-input" value="200" min="0">
                            </div>
                            <div class="input-group">
                                <label>Premium Plan Returns (%)</label>
                                <input type="number" id="premium-returns" class="modal-input" value="25" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>VIP Plan Min ($)</label>
                                <input type="number" id="vip-min" class="modal-input" value="500" min="0">
                            </div>
                            <div class="input-group">
                                <label>VIP Plan Returns (%)</label>
                                <input type="number" id="vip-returns" class="modal-input" value="40" min="0" max="100" step="0.1">
                            </div>
                            <button class="modal-btn" onclick="saveSettings()">
                         Save 
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-user-modal')">&times;</button>
            <h3><i class="fas fa-user-edit"></i> Edit User</h3>
            <input type="hidden" id="edit-user-id">
            
            <div class="input-group">
                <label>Account Balance ($)</label>
                <input type="number" id="edit-balance" class="modal-input" step="0.01" min="0">
            </div>
            
            <div class="input-group">
                <label>Account Status</label>
                <select id="edit-status" class="modal-input">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Activation Status</label>
                <select id="edit-activation" class="modal-input">
                    <option value="true">Activated</option>
                    <option value="false">Not Activated</option>
                </select>
            </div>
            
            <button class="modal-btn" onclick="saveUserChanges()">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button class="modal-btn secondary" onclick="closeModal('edit-user-modal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Delete User Modal -->
    <div id="delete-user-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('delete-user-modal')">&times;</button>
            <h3><i class="fas fa-user-slash" style="color: #dc3545;"></i> Delete User</h3>
            
            <div class="input-group">
                <label>Confirm Admin Password</label>
                <div style="position: relative;">
                    <input type="password" id="delete-confirm-password" class="modal-input" placeholder="Enter admin password to confirm">
                    <button type="button" class="modal-password-toggle" onclick="togglePasswordVisibility('delete-confirm-password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <p style="color: #ffc107; margin: 15px 0; text-align: center;">
                <i class="fas fa-exclamation-triangle"></i> Warning: This action cannot be undone!
            </p>
            
            <button class="modal-btn" onclick="confirmDeleteUser()" style="background: #dc3545;">
                <i class="fas fa-trash"></i> Delete User Permanently
            </button>
            <button class="modal-btn secondary" onclick="closeModal('delete-user-modal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Create Transaction Modal -->
    <div id="create-transaction-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('create-transaction-modal')">&times;</button>
            <h3><i class="fas fa-plus-circle"></i> Create Transaction</h3>
            
            <div class="input-group">
                <label>Select User</label>
                <select id="transaction-user" class="modal-input" onchange="updateUserInfo()">
                    <option value="">Select a user...</option>
                    <!-- Users will be populated here -->
                </select>
            </div>
            
            <div class="input-group">
                <label>Transaction Type</label>
                <select id="transaction-type" class="modal-input">
                    <option value="withdrawal">Withdrawal</option>
                    <option value="deposit">Deposit</option>
                    <option value="earning">Earning</option>
                    <option value="bonus">Bonus</option>
                    <option value="investment">Investment</option>
                    <option value="referral_bonus">Referral Bonus</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Amount ($)</label>
                <input type="number" id="transaction-amount" class="modal-input" placeholder="Enter amount" min="0.01" step="0.01">
            </div>
            
            <div class="input-group">
                <label>Custom Message / Description</label>
                <textarea id="transaction-description" class="modal-input" placeholder="Enter custom message for the user" rows="3"></textarea>
            </div>
            
            <div class="input-group">
                <label>Transaction Status</label>
                <select id="transaction-status" class="modal-input">
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            
            <div id="user-balance-info" style="background: rgba(106, 184, 255, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; display: none;">
                <p style="color: #6ab8ff; margin: 0;">Current Balance: $<span id="current-user-balance">0.00</span></p>
            </div>
            
            <div id="transaction-warning" style="background: rgba(255, 193, 7, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; display: none;">
                <p style="color: #ffc107; margin: 0; font-size: 14px;" id="warning-message"></p>
            </div>
            
            <button class="modal-btn" onclick="createTransaction()">
                <i class="fas fa-check"></i> Create Transaction
            </button>
            <button class="modal-btn secondary" onclick="closeModal('create-transaction-modal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal user-details-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('user-details-modal')">&times;</button>
            
            <div class="user-profile-header">
                <img src="ol3.png" alt="Profile Picture" class="user-profile-pic" id="detail-profile-pic">
                <div class="user-profile-info">
                    <h3 id="detail-username">Loading...</h3>
                    <p style="color: #ccc;" id="detail-user-id">User ID: Loading...</p>
                    <p style="color: #6ab8ff; font-size: 1.5em; margin-top: 10px;" id="detail-main-balance">$0.00</p>
                </div>
            </div>
            
            <div class="user-details-grid">
                <div class="detail-card">
                    <h4><i class="fas fa-user-circle"></i> Personal Information</h4>
                    <div class="detail-item">
                        <span class="detail-label">Full Name:</span>
                        <span class="detail-value" id="detail-full-name">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email Address:</span>
                        <span class="detail-value" id="detail-email">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Phone Number:</span>
                        <span class="detail-value" id="detail-phone">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Country:</span>
                        <span class="detail-value" id="detail-country">
                            <span class="country-flag">ðŸŒ</span> Loading...
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">User ID:</span>
                        <span class="detail-value" id="detail-user-id-value">Loading...</span>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h4><i class="fas fa-chart-line"></i> Account Statistics</h4>
                    <div class="detail-item">
                        <span class="detail-label">Account Status:</span>
                        <span class="detail-value" id="detail-account-status">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Joined Date:</span>
                        <span class="detail-value" id="detail-joined-date">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Login:</span>
                        <span class="detail-value" id="detail-last-login">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Referral Code:</span>
                        <span class="detail-value" id="detail-referral-code">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Referrals:</span>
                        <span class="detail-value" id="detail-total-referrals">0</span>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h4><i class="fas fa-money-bill-wave"></i> Balance Summary</h4>
                    <div class="balance-summary">
                        <div class="balance-item">
                            <span>Main Balance:</span>
                            <span id="detail-main-balance-summary">$0.00</span>
                        </div>
                        <div class="balance-item">
                            <span>Earnings Balance:</span>
                            <span id="detail-earnings-balance">$0.00</span>
                        </div>
                        <div class="balance-item">
                            <span>Referral Balance:</span>
                            <span id="detail-referral-balance">$0.00</span>
                        </div>
                        <div class="balance-item">
                            <span>Bonuses Balance:</span>
                            <span id="detail-bonuses-balance">$0.00</span>
                        </div>
                        <div class="balance-item">
                            <span>Total Withdrawn:</span>
                            <span id="detail-total-withdrawn">$0.00</span>
                        </div>
                        <div class="balance-item" style="background: rgba(106, 184, 255, 0.2); font-weight: bold;">
                            <span>Total Earnings:</span>
                            <span id="detail-total-earnings">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h4><i class="fas fa-users"></i> Referral Information</h4>
                    <div class="detail-item">
                        <span class="detail-label">Referrer:</span>
                        <span class="detail-value" id="detail-referrer">No referrer</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Active Investments:</span>
                        <span class="detail-value" id="detail-active-investments">0</span>
                    </div>
                    
                    <h4 style="margin-top: 20px; color: #6ab8ff;">Referred Users:</h4>
                    <div class="referrals-list" id="detail-referrals-list">
                        <div class="no-data" style="text-align: center; padding: 20px; color: #666;">
                            No referrals yet
                        </div>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h4><i class="fas fa-exchange-alt"></i> Transaction Statistics</h4>
                    <div class="transaction-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="detail-total-transactions">0</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-completed-transactions">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-pending-transactions">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-failed-transactions">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="modal-btn" onclick="showUserTransactions()">
                            <i class="fas fa-list"></i> View All Transactions
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="danger-zone">
                <h4>Danger Zone</h4>
                <p style="color: #ffc107; margin-bottom: 15px;">These actions are irreversible. Proceed with caution.</p>
                
                <div style="display: flex; gap: 1px;">
                    <button class="modal-btn secondary" onclick="editDetailUser()" style="flex: 1;">Edit</button>
                    <button class="modal-btn secondary" onclick="suspendDetailUser()" style="flex: 1;">Suspend</button>
                    <button class="modal-btn" onclick="deleteCompletedTransactions()" style="background: #dc3545; flex: 1;">TXNs<sup>x</sup>
                    </button>
                </div>
            </div>
            
            <button class="modal-btn secondary" onclick="closeModal('user-details-modal')" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
    
    <!-- View Comment Details Modal - NEW -->
    <div id="view-comment-modal" class="modal">
        <div class="modal-content large">
            <button class="close-btn" onclick="closeModal('view-comment-modal')">&times;</button>
            <h3><i class="fas fa-comment-dots"></i> Comment Details</h3>
            
            <div class="comment-details" id="comment-details-content">
                <!-- Comment content will be loaded here -->
            </div>
            
            <div class="comment-meta" id="comment-meta-info">
                <!-- Meta information will be loaded here -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn" onclick="approveCurrentComment()" style="background: #28a745;">
                    <i class="fas fa-check"></i> Approve Comment
                </button>
                <button class="modal-btn" onclick="rejectCurrentComment()" style="background: #ffc107; color: black;">
                    <i class="fas fa-times"></i> Reject Comment
                </button>
                <button class="modal-btn" onclick="deleteCurrentComment()" style="background: #dc3545;">
                    <i class="fas fa-trash"></i> Delete Comment
                </button>
                <button class="modal-btn secondary" onclick="closeModal('view-comment-modal')">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Comments Confirmation Modal - NEW -->
    <div id="delete-comments-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('delete-comments-modal')">&times;</button>
            <h3><i class="fas fa-trash" style="color: #dc3545;"></i> Delete Comments</h3>
            
            <div class="input-group">
                <label>Confirm Admin Password</label>
                <div style="position: relative;">
                    <input type="password" id="delete-comments-password" class="modal-input" placeholder="Enter admin password to confirm">
                    <button type="button" class="modal-password-toggle" onclick="togglePasswordVisibility('delete-comments-password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <p style="color: #ffc107; margin: 15px 0; text-align: center;">
                <i class="fas fa-exclamation-triangle"></i> 
                <span id="delete-comments-count">0</span> comments will be permanently deleted!
            </p>
            
            <div style="background: rgba(220, 53, 69, 0.1); padding: 10px; border-radius: 5px; margin: 15px 0;">
                <p style="color: #dc3545; margin: 0; font-size: 14px;">
                    <i class="fas fa-exclamation-circle"></i> This action cannot be undone. All selected comments will be permanently removed.
                </p>
            </div>
            
            <button class="modal-btn" onclick="confirmDeleteComments()" style="background: #dc3545;">
                <i class="fas fa-trash"></i> Delete Selected Comments
            </button>
            <button class="modal-btn secondary" onclick="closeModal('delete-comments-modal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Firebase Configuration and Main Script -->
    <script>
        // ==============================================
        // FIREBASE CONFIGURATION
        // ==============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAJaFVETxpy8Vr5e6RXDWi3NBhEUaZEPN4",
            authDomain: "malcolm-finance.firebaseapp.com",
            projectId: "malcolm-finance",
            storageBucket: "malcolm-finance.firebasestorage.app",
            messagingSenderId: "987613399580",
            appId: "1:987613399580:web:0237b2c8c2c7df54222dd9",
            measurementId: "G-1CEG3BWFBP"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        let isAdminLoggedIn = false;
        let allUsers = [];
        let allTransactions = [];
        let allWithdrawals = [];
        let allInvestments = [];
        let allReferrals = [];
        let allComments = [];
        let filteredComments = [];
        let selectedCommentIds = new Set();
        let currentEditingUserId = null;
        let userToDelete = null;
        let detailUserId = null;
        let currentCommentId = null;
        let commentsToDelete = [];
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 800; // milliseconds
        let currentFilter = 'all';
        
        // Admin Password (Change this for security)
        const ADMIN_PASSWORD = "22cabbage";
        
        // Country detection from phone number
        const COUNTRY_CODES = {
            '+256': { name: 'Uganda', flag: 'ðŸ‡ºðŸ‡¬' },
            '+255': { name: 'Tanzania', flag: 'ðŸ‡¹ðŸ‡¿' },
            '+254': { name: 'Kenya', flag: 'ðŸ‡°ðŸ‡ª' },
            '+234': { name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬' },
            '+233': { name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­' },
            '+27': { name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦' },
            '+1': { name: 'USA/Canada', flag: 'ðŸ‡ºðŸ‡¸' },
            '+44': { name: 'UK', flag: 'ðŸ‡¬ðŸ‡§' },
            '+91': { name: 'India', flag: 'ðŸ‡®ðŸ‡³' },
            '+86': { name: 'China', flag: 'ðŸ‡¨ðŸ‡³' },
            '+49': { name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª' },
            '+33': { name: 'France', flag: 'ðŸ‡«ðŸ‡·' },
            '+39': { name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹' },
            '+34': { name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸' },
            '+61': { name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º' },
            '+55': { name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·' },
            '+7': { name: 'Russia', flag: 'ðŸ‡·ðŸ‡º' }
        };
        
        function detectCountryFromPhone(phone) {
            if (!phone) return { name: 'Unknown', flag: 'ðŸŒ' };
            
            for (const [code, country] of Object.entries(COUNTRY_CODES)) {
                if (phone.startsWith(code)) {
                    return country;
                }
            }
            
            return { name: 'Unknown', flag: 'ðŸŒ' };
        }
        
        // ==============================================
        // PASSWORD TOGGLE FUNCTION
        // ==============================================
        function togglePasswordVisibility(inputId, toggleButton) {
            const input = document.getElementById(inputId);
            const icon = toggleButton.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Admin panel initialized");
            
            // Check if already logged in
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                showAdminPanel();
                loadAllData();
                loadSettings(); // Load settings on startup
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });
        
        // ==============================================
        // ADMIN AUTHENTICATION
        // ==============================================
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const messageDiv = document.getElementById('login-message');
            
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                showSuccessMessage(messageDiv, 'Login successful!');
                showAdminPanel();
                loadAllData();
                loadSettings(); // Load settings after login
            } else {
                showErrorMessage(messageDiv, 'Access Denied!');
            }
        }
        
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminLoggedIn');
                location.reload();
            }
        }
        
        function showAdminPanel() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
        }
        
        // ==============================================
        // TAB MANAGEMENT
        // ==============================================
        function showTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Load data for tab if needed
            switch(tabId) {
                case 'users':
                    if (allUsers.length === 0) loadUsers();
                    break;
                case 'comments':
                    if (allComments.length === 0) loadComments();
                    break;
                case 'referrals':
                    if (allReferrals.length === 0) loadReferrals();
                    break;
                case 'transactions':
                    if (allTransactions.length === 0) loadTransactions();
                    break;
                case 'withdrawals':
                    if (allWithdrawals.length === 0) loadWithdrawals();
                    break;
                case 'investments':
                    if (allInvestments.length === 0) loadInvestments();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // ==============================================
        // LOAD ALL DATA
        // ==============================================
        async function loadAllData() {
            try {
                await Promise.all([
                    loadDashboardStats(),
                    loadUsers(),
                    loadComments(),
                    loadReferrals(),
                    loadTransactions(),
                    loadWithdrawals(),
                    loadInvestments()
                ]);
                showSuccessMessage(null, 'All data loaded successfully!');
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }
        
        // ==============================================
        // LOAD SETTINGS
        // ==============================================
        async function loadSettings() {
            try {
                const doc = await db.collection('settings').doc('system').get();
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Populate all settings fields
                    document.getElementById('activation-fee').value = data.activationFee || 50;
                    document.getElementById('min-deposit').value = data.minDeposit || 10;
                    document.getElementById('min-withdrawal').value = data.minWithdrawal || 10;
                    document.getElementById('withdrawal-fee').value = data.withdrawalFee || 5;
                    document.getElementById('referral-bonus').value = data.referralBonus || 10;
                    document.getElementById('daily-earnings').value = data.dailyEarnings || 0.10;
                    document.getElementById('starter-min').value = data.starterMin || 50;
                    document.getElementById('starter-returns').value = data.starterReturns || 15;
                    document.getElementById('premium-min').value = data.premiumMin || 200;
                    document.getElementById('premium-returns').value = data.premiumReturns || 25;
                    document.getElementById('vip-min').value = data.vipMin || 500;
                    document.getElementById('vip-returns').value = data.vipReturns || 40;
                    
                    console.log("Settings loaded successfully");
                } else {
                    // Use defaults if no settings exist
                    setDefaultSettings();
                    console.log("Using default settings");
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                setDefaultSettings();
            }
        }
        
        function setDefaultSettings() {
            document.getElementById('activation-fee').value = 50;
            document.getElementById('min-deposit').value = 10;
            document.getElementById('min-withdrawal').value = 10;
            document.getElementById('withdrawal-fee').value = 5;
            document.getElementById('referral-bonus').value = 10;
            document.getElementById('daily-earnings').value = 0.10;
            document.getElementById('starter-min').value = 50;
            document.getElementById('starter-returns').value = 15;
            document.getElementById('premium-min').value = 200;
            document.getElementById('premium-returns').value = 25;
            document.getElementById('vip-min').value = 500;
            document.getElementById('vip-returns').value = 40;
        }
        
        // ==============================================
        // SAVE SETTINGS
        // ==============================================
        async function saveSettings() {
            const activationFee = parseFloat(document.getElementById('activation-fee').value);
            const minDeposit = parseFloat(document.getElementById('min-deposit').value);
            const minWithdrawal = parseFloat(document.getElementById('min-withdrawal').value);
            const withdrawalFee = parseFloat(document.getElementById('withdrawal-fee').value);
            const referralBonus = parseFloat(document.getElementById('referral-bonus').value);
            const dailyEarnings = parseFloat(document.getElementById('daily-earnings').value);
            const starterMin = parseFloat(document.getElementById('starter-min').value);
            const starterReturns = parseFloat(document.getElementById('starter-returns').value);
            const premiumMin = parseFloat(document.getElementById('premium-min').value);
            const premiumReturns = parseFloat(document.getElementById('premium-returns').value);
            const vipMin = parseFloat(document.getElementById('vip-min').value);
            const vipReturns = parseFloat(document.getElementById('vip-returns').value);
            
            // Validate inputs
            if (isNaN(activationFee) || activationFee < 0) {
                alert('Please enter a valid activation fee');
                return;
            }
            
            if (isNaN(minWithdrawal) || minWithdrawal < 0) {
                alert('Please enter a valid minimum withdrawal amount');
                return;
            }
            
            if (isNaN(withdrawalFee) || withdrawalFee < 0 || withdrawalFee > 100) {
                alert('Please enter a valid withdrawal fee (0-100%)');
                return;
            }
            
            try {
                await db.collection('settings').doc('system').set({
                    activationFee: activationFee,
                    minDeposit: minDeposit,
                    minWithdrawal: minWithdrawal,
                    withdrawalFee: withdrawalFee,
                    referralBonus: referralBonus,
                    dailyEarnings: dailyEarnings,
                    starterMin: starterMin,
                    starterReturns: starterReturns,
                    premiumMin: premiumMin,
                    premiumReturns: premiumReturns,
                    vipMin: vipMin,
                    vipReturns: vipReturns,
                    updatedAt: new Date().toISOString(),
                    updatedBy: 'admin'
                }, { merge: true });
                
                // Also update the settings in real-time for all users
                await updateUserSettingsInRealTime({
                    minWithdrawal: minWithdrawal,
                    withdrawalFee: withdrawalFee,
                    dailyEarnings: dailyEarnings,
                    starterMin: starterMin,
                    starterReturns: starterReturns,
                    premiumMin: premiumMin,
                    premiumReturns: premiumReturns,
                    vipMin: vipMin,
                    vipReturns: vipReturns
                });
                
                alert('Settings saved successfully! These changes will affect all users immediately.');
                
            } catch (error) {
                console.error("Error saving settings:", error);
                alert('Error saving settings: ' + error.message);
            }
        }
        
        // Function to update settings in real-time for all users
        async function updateUserSettingsInRealTime(newSettings) {
            try {
                // This function can be expanded to update user-specific settings
                // For now, we'll just log that settings have been updated
                console.log("Global settings updated:", newSettings);
                
                // You could add a broadcast system here if needed
                // For example, using Firebase Cloud Messaging to notify users
                
            } catch (error) {
                console.error("Error updating real-time settings:", error);
            }
        }
        
        // ==============================================
        // DASHBOARD STATS
        // ==============================================
        async function loadDashboardStats() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                
                // Calculate stats
                let totalUsers = usersSnapshot.size;
                let activeUsers = allUsers.filter(user => user.isActive).length;
                let totalBalance = allUsers.reduce((sum, user) => sum + (parseFloat(user.balance) || 0), 0);
                
                // Load pending withdrawals (using fallback method)
                let pendingWithdrawals = 0;
                try {
                    // Try with index first
                    const withdrawalsSnapshot = await db.collection('transactions')
                        .where('type', '==', 'withdrawal')
                        .where('status', '==', 'pending')
                        .get();
                    pendingWithdrawals = withdrawalsSnapshot.size;
                } catch (error) {
                    // If index error, count manually
                    const allTxns = await db.collection('transactions').get();
                    allTxns.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'withdrawal' && data.status === 'pending') {
                            pendingWithdrawals++;
                        }
                    });
                }
                
                // Load pending comments
                let pendingComments = 0;
                try {
                    const commentsSnapshot = await db.collection('comments')
                        .where('status', '==', 'pending')
                        .get();
                    pendingComments = commentsSnapshot.size;
                } catch (error) {
                    const allCommentsSnap = await db.collection('comments').get();
                    allCommentsSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'pending') {
                            pendingComments++;
                        }
                    });
                }
                
                // Update stats
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('active-users').textContent = activeUsers;
                document.getElementById('total-balance').textContent = '$' + totalBalance.toFixed(2);
                document.getElementById('pending-withdrawals').textContent = pendingWithdrawals;
                document.getElementById('pending-comments').textContent = pendingComments;
                
            } catch (error) {
                console.error("Error loading dashboard stats:", error);
            }
        }
        
        // ==============================================
        // LOAD USERS
        // ==============================================
        async function loadUsers() {
            try {
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ 
                        id: doc.id, 
                        ...doc.data(),
                        balance: parseFloat(doc.data().balance) || 0
                    });
                });
                
                updateUsersTable();
                
            } catch (error) {
                console.error("Error loading users:", error);
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-users-slash"></i><br>
                                No users found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateUsersTable() {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            
            if (allUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-users-slash"></i><br>
                                No users found
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            document.getElementById('users-count').textContent = `${allUsers.length} users`;
            
            allUsers.forEach(user => {
                const row = tbody.insertRow();
                row.className = 'user-row';
                const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                const profilePic = user.profilePictureUrl || 'ol3.png';
                
                // Add long press event listeners
                row.addEventListener('touchstart', function(e) {
                    longPressTimer = setTimeout(() => {
                        showUserDetails(user.id);
                        this.classList.add('long-press-active');
                    }, LONG_PRESS_DURATION);
                });
                
                row.addEventListener('touchend', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.addEventListener('touchmove', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                // For desktop
                row.addEventListener('mousedown', function(e) {
                    longPressTimer = setTimeout(() => {
                        showUserDetails(user.id);
                        this.classList.add('long-press-active');
                    }, LONG_PRESS_DURATION);
                });
                
                row.addEventListener('mouseup', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.addEventListener('mouseleave', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.innerHTML = `
                    <td>
                        <img src="${profilePic}" class="profile-pic-small" alt="${user.name}" onerror="this.src='ol3.png'">
                    </td>
                    <td>
                        <strong>${user.name || 'N/A'}</strong><br>
                        <small style="color: #666;">${user.phone || 'No phone'}</small>
                    </td>
                    <td>${user.email || 'N/A'}</td>
                    <td>
                        <strong style="color: #6ab8ff;">$${(user.balance || 0).toFixed(2)}</strong>
                    </td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                            ${user.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <code style="color: #6ab8ff; background: rgba(106, 184, 255, 0.1); padding: 3px 6px; border-radius: 3px;">
                            ${user.referralCode || 'N/A'}
                        </code>
                    </td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editUser('${user.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${user.isActive ? 'suspend-btn' : 'activate-btn'}" 
                                onclick="${user.isActive ? 'suspendUser' : 'activateUser'}('${user.id}')" title="${user.isActive ? 'Suspend' : 'Activate'}">
                            <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteUserPrompt('${user.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        // ==============================================
        // USER DETAILS MODAL
        // ==============================================
        async function showUserDetails(userId) {
            detailUserId = userId;
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Reset modal content
            document.getElementById('detail-profile-pic').src = user.profilePictureUrl || 'ol3.png';
            document.getElementById('detail-username').textContent = user.name || 'N/A';
            document.getElementById('detail-user-id').textContent = `User ID: ${user.id.substring(0, 8)}...`;
            document.getElementById('detail-user-id-value').textContent = user.id;
            document.getElementById('detail-full-name').textContent = user.name || 'N/A';
            document.getElementById('detail-email').textContent = user.email || 'N/A';
            document.getElementById('detail-phone').textContent = user.phone || 'N/A';
            document.getElementById('detail-main-balance').textContent = `$${(user.balance || 0).toFixed(2)}`;
            document.getElementById('detail-main-balance-summary').textContent = `$${(user.balance || 0).toFixed(2)}`;
            
            // Country detection
            const country = detectCountryFromPhone(user.phone || '');
            document.getElementById('detail-country').innerHTML = `<span class="country-flag">${country.flag}</span> ${country.name}`;
            
            // Account status
            document.getElementById('detail-account-status').innerHTML = user.isActive ? 
                '<span class="status-badge status-active">Active</span>' : 
                '<span class="status-badge status-inactive">Inactive</span>';
            
            // Dates
            document.getElementById('detail-joined-date').textContent = user.createdAt ? 
                new Date(user.createdAt).toLocaleString() : 'N/A';
            document.getElementById('detail-last-login').textContent = user.lastLogin ? 
                new Date(user.lastLogin).toLocaleString() : 'Never';
            
            // Referral info
            document.getElementById('detail-referral-code').textContent = user.referralCode || 'N/A';
            document.getElementById('detail-total-referrals').textContent = user.referrals || 0;
            
            // Find referrer
            if (user.referredBy) {
                const referrer = allUsers.find(u => u.referralCode === user.referredBy);
                document.getElementById('detail-referrer').textContent = referrer ? 
                    `${referrer.name} (${referrer.email})` : 
                    `Code: ${user.referredBy}`;
            } else {
                document.getElementById('detail-referrer').textContent = 'No referrer';
            }
            
            // Load additional data
            await loadUserDetailedData(userId);
            
            showModal('user-details-modal');
        }
        
        async function loadUserDetailedData(userId) {
            try {
                // Load user's transactions for stats
                const transactionsSnapshot = await db.collection('transactions')
                    .where('userId', '==', userId)
                    .get();
                
                let totalTransactions = 0;
                let completedTransactions = 0;
                let pendingTransactions = 0;
                let failedTransactions = 0;
                
                let earningsBalance = 0;
                let referralBalance = 0;
                let bonusesBalance = 0;
                let totalWithdrawn = 0;
                
                transactionsSnapshot.forEach(doc => {
                    const txn = doc.data();
                    totalTransactions++;
                    
                    if (txn.status === 'completed') completedTransactions++;
                    if (txn.status === 'pending') pendingTransactions++;
                    if (txn.status === 'rejected' || txn.status === 'failed') failedTransactions++;
                    
                    if (txn.status === 'completed') {
                        const amount = parseFloat(txn.amount) || 0;
                        switch(txn.type) {
                            case 'earning':
                                earningsBalance += amount;
                                break;
                            case 'referral_bonus':
                                referralBalance += amount;
                                break;
                            case 'bonus':
                                bonusesBalance += amount;
                                break;
                            case 'withdrawal':
                                totalWithdrawn += amount;
                                break;
                        }
                    }
                });
                
                // Update transaction stats
                document.getElementById('detail-total-transactions').textContent = totalTransactions;
                document.getElementById('detail-completed-transactions').textContent = completedTransactions;
                document.getElementById('detail-pending-transactions').textContent = pendingTransactions;
                document.getElementById('detail-failed-transactions').textContent = failedTransactions;
                
                // Update balance details
                document.getElementById('detail-earnings-balance').textContent = `$${earningsBalance.toFixed(2)}`;
                document.getElementById('detail-referral-balance').textContent = `$${referralBalance.toFixed(2)}`;
                document.getElementById('detail-bonuses-balance').textContent = `$${bonusesBalance.toFixed(2)}`;
                document.getElementById('detail-total-withdrawn').textContent = `$${totalWithdrawn.toFixed(2)}`;
                
                const totalEarnings = earningsBalance + referralBalance + bonusesBalance;
                document.getElementById('detail-total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;
                
                // Load active investments
                const activeInvestments = await db.collection('transactions')
                    .where('userId', '==', userId)
                    .where('type', '==', 'investment')
                    .where('status', '==', 'completed')
                    .get();
                
                document.getElementById('detail-active-investments').textContent = activeInvestments.size;
                
                // Load referred users
                const user = allUsers.find(u => u.id === userId);
                if (user && user.referralCode) {
                    const referredUsers = allUsers.filter(u => u.referredBy === user.referralCode);
                    const referralsList = document.getElementById('detail-referrals-list');
                    referralsList.innerHTML = '';
                    
                    if (referredUsers.length > 0) {
                        referredUsers.forEach(refUser => {
                            const referralItem = document.createElement('div');
                            referralItem.className = 'referral-item';
                            referralItem.innerHTML = `
                                <img src="${refUser.profilePictureUrl || 'ol3.png'}" class="referral-pic" alt="${refUser.name}" onerror="this.src='ol3.png'">
                                <div style="flex: 1;">
                                    <strong>${refUser.name}</strong><br>
                                    <small style="color: #ccc;">${refUser.email}</small>
                                </div>
                                <div style="color: #6ab8ff; font-size: 0.9em;">
                                    ${refUser.createdAt ? new Date(refUser.createdAt).toLocaleDateString() : 'N/A'}
                                </div>
                            `;
                            referralsList.appendChild(referralItem);
                        });
                    } else {
                        referralsList.innerHTML = '<div class="no-data" style="text-align: center; padding: 20px; color: #666;">No referrals yet</div>';
                    }
                }
                
            } catch (error) {
                console.error("Error loading detailed user data:", error);
            }
        }
        
        function editDetailUser() {
            if (detailUserId) {
                editUser(detailUserId);
                closeModal('user-details-modal');
            }
        }
        
        function suspendDetailUser() {
            if (detailUserId) {
                const user = allUsers.find(u => u.id === detailUserId);
                if (user) {
                    if (user.isActive) {
                        suspendUser(detailUserId);
                    } else {
                        activateUser(detailUserId);
                    }
                    closeModal('user-details-modal');
                }
            }
        }
        
        async function deleteCompletedTransactions() {
            if (!detailUserId) return;
            
            if (!confirm('Are you sure you want to delete ALL completed transactions for this user? This action cannot be undone!')) {
                return;
            }
            
            const password = prompt('Enter admin password to confirm:');
            if (password !== ADMIN_PASSWORD) {
                alert('Invalid admin password!');
                return;
            }
            
            try {
                // Get all completed transactions for the user
                const transactionsSnapshot = await db.collection('transactions')
                    .where('userId', '==', detailUserId)
                    .where('status', '==', 'completed')
                    .get();
                
                if (transactionsSnapshot.empty) {
                    alert('No completed transactions found for this user.');
                    return;
                }
                
                // Delete each transaction
                const deletePromises = [];
                transactionsSnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                
                await Promise.all(deletePromises);
                
                alert(`Successfully deleted ${deletePromises.length} completed transactions.`);
                closeModal('user-details-modal');
                loadAllData();
                
            } catch (error) {
                console.error("Error deleting transactions:", error);
                alert('Error deleting transactions: ' + error.message);
            }
        }
        
        function showUserTransactions() {
            if (detailUserId) {
                const user = allUsers.find(u => u.id === detailUserId);
                if (user) {
                    // Search for this user in transactions
                    document.getElementById('search-input').value = user.email || user.name || user.id;
                    searchTable();
                    showTab('transactions');
                    closeModal('user-details-modal');
                }
            }
        }
        
        // ==============================================
        // USER MANAGEMENT FUNCTIONS
        // ==============================================
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUserId = userId;
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-balance').value = user.balance || 0;
            document.getElementById('edit-status').value = user.status || 'active';
            document.getElementById('edit-activation').value = user.isActive ? 'true' : 'false';
            
            showModal('edit-user-modal');
        }
        
        async function saveUserChanges() {
            const userId = currentEditingUserId;
            const balance = parseFloat(document.getElementById('edit-balance').value);
            const status = document.getElementById('edit-status').value;
            const isActive = document.getElementById('edit-activation').value === 'true';
            
            if (!userId) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    balance: balance,
                    status: status,
                    isActive: isActive,
                    updatedAt: new Date().toISOString()
                });
                
                alert('User updated successfully!');
                closeModal('edit-user-modal');
                loadUsers();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error updating user:", error);
                alert('Error updating user: ' + error.message);
            }
        }
        
        async function activateUser(userId) {
            if (confirm('Activate this user account?')) {
                try {
                    await db.collection('users').doc(userId).update({
                        isActive: true,
                        status: 'active',
                        updatedAt: new Date().toISOString()
                    });
                    
                    alert('User activated successfully!');
                    loadUsers();
                    loadDashboardStats();
                    
                } catch (error) {
                    console.error("Error activating user:", error);
                    alert('Error activating user: ' + error.message);
                }
            }
        }
        
        async function suspendUser(userId) {
            if (confirm('Suspend this user account?')) {
                try {
                    await db.collection('users').doc(userId).update({
                        isActive: false,
                        status: 'suspended',
                        updatedAt: new Date().toISOString()
                    });
                    
                    alert('User suspended successfully!');
                    loadUsers();
                    loadDashboardStats();
                    
                } catch (error) {
                    console.error("Error suspending user:", error);
                    alert('Error suspending user: ' + error.message);
                }
            }
        }
        
        // ==============================================
        // DELETE USER FUNCTIONS
        // ==============================================
        function deleteUserPrompt(userId) {
            userToDelete = userId;
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            showModal('delete-user-modal');
            document.getElementById('delete-confirm-password').value = '';
        }
        
        async function confirmDeleteUser() {
            const password = document.getElementById('delete-confirm-password').value;
            
            if (password !== ADMIN_PASSWORD) {
                alert('Invalid admin password!');
                return;
            }
            
            if (!userToDelete) return;
            
            if (confirm('Are you absolutely sure you want to delete this user? This action cannot be undone!')) {
                try {
                    // Delete user document
                    await db.collection('users').doc(userToDelete).delete();
                    
                    // Delete user's transactions
                    const transactionsSnapshot = await db.collection('transactions')
                        .where('userId', '==', userToDelete)
                        .get();
                    
                    const deletePromises = [];
                    transactionsSnapshot.forEach(doc => {
                        deletePromises.push(doc.ref.delete());
                    });
                    
                    await Promise.all(deletePromises);
                    
                    alert('User deleted successfully!');
                    closeModal('delete-user-modal');
                    loadUsers();
                    loadDashboardStats();
                    loadReferrals();
                    
                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert('Error deleting user: ' + error.message);
                }
            }
        }
        
        // ==============================================
        // CREATE TRANSACTION FUNCTIONALITY
        // ==============================================
        function showCreateTransactionModal() {
            // Populate user dropdown
            const userSelect = document.getElementById('transaction-user');
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email}) - Balance: $${(user.balance || 0).toFixed(2)}`;
                userSelect.appendChild(option);
            });
            
            // Reset form
            document.getElementById('transaction-type').value = 'withdrawal';
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-description').value = '';
            document.getElementById('transaction-status').value = 'completed';
            document.getElementById('user-balance-info').style.display = 'none';
            document.getElementById('transaction-warning').style.display = 'none';
            
            showModal('create-transaction-modal');
        }
        
        function updateUserInfo() {
            const userId = document.getElementById('transaction-user').value;
            const userBalanceInfo = document.getElementById('user-balance-info');
            const transactionWarning = document.getElementById('transaction-warning');
            
            if (!userId) {
                userBalanceInfo.style.display = 'none';
                transactionWarning.style.display = 'none';
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                document.getElementById('current-user-balance').textContent = (user.balance || 0).toFixed(2);
                userBalanceInfo.style.display = 'block';
                
                // Update warning based on transaction type
                updateTransactionWarning();
            }
        }
        
        function updateTransactionWarning() {
            const userId = document.getElementById('transaction-user').value;
            const transactionType = document.getElementById('transaction-type').value;
            const transactionAmount = parseFloat(document.getElementById('transaction-amount').value) || 0;
            const transactionWarning = document.getElementById('transaction-warning');
            
            if (!userId || transactionAmount <= 0) {
                transactionWarning.style.display = 'none';
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const currentBalance = user.balance || 0;
            
            if (transactionType === 'withdrawal' && transactionAmount > currentBalance) {
                document.getElementById('warning-message').textContent = 
                    `Warning: User has insufficient balance! Current: $${currentBalance.toFixed(2)}, Withdrawal: $${transactionAmount.toFixed(2)}`;
                transactionWarning.style.display = 'block';
            } else if (transactionType === 'deposit') {
                document.getElementById('warning-message').textContent = 
                    `This will add $${transactionAmount.toFixed(2)} to user's balance. New balance: $${(currentBalance + transactionAmount).toFixed(2)}`;
                transactionWarning.style.display = 'block';
            } else if (transactionType === 'withdrawal') {
                document.getElementById('warning-message').textContent = 
                    `This will deduct $${transactionAmount.toFixed(2)} from user's balance. New balance: $${(currentBalance - transactionAmount).toFixed(2)}`;
                transactionWarning.style.display = 'block';
            } else {
                transactionWarning.style.display = 'none';
            }
        }
        
        // Add event listeners for real-time warning updates
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('transaction-type').addEventListener('change', updateTransactionWarning);
            document.getElementById('transaction-amount').addEventListener('input', updateTransactionWarning);
        });
        
        async function createTransaction() {
            const userId = document.getElementById('transaction-user').value;
            const transactionType = document.getElementById('transaction-type').value;
            const transactionAmount = parseFloat(document.getElementById('transaction-amount').value);
            const transactionDescription = document.getElementById('transaction-description').value.trim();
            const transactionStatus = document.getElementById('transaction-status').value;
            
            // Validation
            if (!userId) {
                alert('Please select a user');
                return;
            }
            
            if (!transactionAmount || transactionAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!transactionDescription) {
                alert('Please enter a transaction description/message');
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            const currentBalance = user.balance || 0;
            
            // Check balance for withdrawals
            if (transactionType === 'withdrawal' && transactionAmount > currentBalance) {
                if (!confirm(`User has insufficient balance! Current: $${currentBalance.toFixed(2)}\nDo you want to proceed anyway?`)) {
                    return;
                }
            }
            
            try {
                // Create transaction in Firestore
                const transactionData = {
                    userId: userId,
                    type: transactionType,
                    amount: transactionAmount,
                    description: transactionDescription,
                    status: transactionStatus,
                    date: new Date().toISOString(),
                    createdBy: 'admin',
                    adminNotes: 'Admin created transaction'
                };
                
                // Add additional fields based on transaction type
                if (transactionType === 'withdrawal') {
                    transactionData.method = 'admin';
                    transactionData.wallet = 'Processed by admin';
                    transactionData.netAmount = transactionAmount;
                }
                
                const transactionRef = await db.collection('transactions').add(transactionData);
                
                // Update user balance based on transaction type and status
                if (transactionStatus === 'completed') {
                    let newBalance = currentBalance;
                    
                    if (transactionType === 'withdrawal') {
                        newBalance -= transactionAmount;
                    } else if (transactionType === 'deposit' || transactionType === 'earning' || 
                               transactionType === 'bonus' || transactionType === 'referral_bonus') {
                        newBalance += transactionAmount;
                    }
                    // Note: investment type might need special handling
                    
                    // Update user balance in Firestore
                    await db.collection('users').doc(userId).update({
                        balance: newBalance,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update total earnings if it's an earning
                    if (transactionType === 'earning') {
                        await db.collection('users').doc(userId).update({
                            totalEarnings: firebase.firestore.FieldValue.increment(transactionAmount)
                        });
                    }
                }
                
                alert('Transaction created successfully!');
                closeModal('create-transaction-modal');
                
                // Refresh data
                loadUsers();
                loadTransactions();
                loadDashboardStats();
                
                // If this was a withdrawal, refresh withdrawals tab
                if (transactionType === 'withdrawal') {
                    loadWithdrawals();
                }
                
            } catch (error) {
                console.error("Error creating transaction:", error);
                alert('Error creating transaction: ' + error.message);
            }
        }
        
        // ==============================================
        // LOAD REFERRALS
        // ==============================================
        async function loadReferrals() {
            try {
                const tbody = document.getElementById('referrals-tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                const snapshot = await db.collection('users').get();
                allReferrals = [];
                
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    if (user.referredBy) {
                        allReferrals.push({
                            id: doc.id,
                            userName: user.name,
                            userEmail: user.email,
                            userProfilePic: user.profilePictureUrl || 'ol3.png',
                            referredBy: user.referredBy,
                            referralCode: user.referralCode,
                            createdAt: user.createdAt,
                            status: 'pending'
                        });
                    }
                });
                
                updateReferralsTable();
                
            } catch (error) {
                console.error("Error loading referrals:", error);
                const tbody = document.getElementById('referrals-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-user-friends"></i><br>
                                No pending referrals found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateReferralsTable() {
            const tbody = document.getElementById('referrals-tbody');
            tbody.innerHTML = '';
            
            if (allReferrals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-user-friends"></i><br>
                                No pending referrals found
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('referrals-count').textContent = '0 referrals';
                return;
            }
            
            document.getElementById('referrals-count').textContent = `${allReferrals.length} referrals`;
            
            allReferrals.forEach(referral => {
                const row = tbody.insertRow();
                const date = referral.createdAt ? new Date(referral.createdAt).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>
                        <img src="${referral.userProfilePic}" class="profile-pic-small" alt="${referral.userName}" onerror="this.src='ol3.png'">
                    </td>
                    <td>
                        <strong>${referral.userName || 'N/A'}</strong><br>
                        <small style="color: #666;">${referral.userEmail || 'No email'}</small>
                    </td>
                    <td>${referral.referredBy || 'N/A'}</td>
                    <td><code>${referral.referralCode || 'N/A'}</code></td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge status-pending">
                            Pending
                        </span>
                    </td>
                    <td>
                        <button class="action-btn activate-btn" onclick="approveReferral('${referral.id}')" title="Approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="action-btn delete-btn" onclick="rejectReferral('${referral.id}')" title="Reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                `;
            });
        }
        
        async function approveReferral(userId) {
            if (confirm('Approve this referral and remove it from the list?')) {
                try {
                    // Get referral bonus from settings
                    let referralBonus = 10; // Default
                    try {
                        const settingsDoc = await db.collection('settings').doc('system').get();
                        if (settingsDoc.exists) {
                            referralBonus = settingsDoc.data().referralBonus || 10;
                        }
                    } catch (error) {
                        console.error("Error getting referral bonus from settings:", error);
                    }
                    
                    // Remove the referredBy field (marking it as approved)
                    await db.collection('users').doc(userId).update({
                        referredBy: firebase.firestore.FieldValue.delete(),
                        referralApproved: true,
                        referralApprovedAt: new Date().toISOString()
                    });
                    
                    // Find the referrer and update their referral bonus
                    const userDoc = await db.collection('users').doc(userId).get();
                    const userData = userDoc.data();
                    
                    if (userData.referredBy) {
                        const referrerSnapshot = await db.collection('users')
                            .where('referralCode', '==', userData.referredBy)
                            .get();
                        
                        if (!referrerSnapshot.empty) {
                            const referrerDoc = referrerSnapshot.docs[0];
                            const referrerData = referrerDoc.data();
                            
                            // Add referral bonus to referrer using the setting
                            const newBalance = (referrerData.balance || 0) + referralBonus;
                            
                            await db.collection('users').doc(referrerDoc.id).update({
                                balance: newBalance,
                                referralEarnings: (referrerData.referralEarnings || 0) + referralBonus
                            });
                            
                            // Create bonus transaction for referrer
                            await db.collection('transactions').add({
                                userId: referrerDoc.id,
                                type: 'referral_bonus',
                                amount: referralBonus,
                                description: `Referral bonus for ${userData.name}`,
                                date: new Date().toISOString(),
                                status: 'completed'
                            });
                        }
                    }
                    
                    alert(`Referral approved and $${referralBonus} bonus awarded!`);
                    loadReferrals();
                    loadUsers();
                    loadDashboardStats();
                    
                } catch (error) {
                    console.error("Error approving referral:", error);
                    alert('Error approving referral: ' + error.message);
                }
            }
        }
        
        async function rejectReferral(userId) {
            if (confirm('Reject this referral and remove it from the list?')) {
                try {
                    // Remove the referredBy field without giving bonus
                    await db.collection('users').doc(userId).update({
                        referredBy: firebase.firestore.FieldValue.delete(),
                        referralRejected: true
                    });
                    
                    alert('Referral rejected!');
                    loadReferrals();
                    
                } catch (error) {
                    console.error("Error rejecting referral:", error);
                    alert('Error rejecting referral: ' + error.message);
                }
            }
        }
        
        // ==============================================
        // LOAD TRANSACTIONS (No index issues)
        // ==============================================
        async function loadTransactions() {
            try {
                const tbody = document.getElementById('transactions-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                const snapshot = await db.collection('transactions')
                    .orderBy('date', 'desc')
                    .limit(50)
                    .get();
                
                allTransactions = [];
                snapshot.forEach(doc => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });
                
                updateTransactionsTable();
                
            } catch (error) {
                console.error("Error loading transactions:", error);
                const tbody = document.getElementById('transactions-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-exchange-alt"></i><br>
                                No transactions found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactions-tbody');
            tbody.innerHTML = '';
            
            if (allTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-exchange-alt"></i><br>
                                No transactions found
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allTransactions.forEach(txn => {
                const row = tbody.insertRow();
                const date = txn.date ? new Date(txn.date).toLocaleString() : 'N/A';
                const user = allUsers.find(u => u.id === txn.userId);
                const userName = user ? user.name : 'Unknown User';
                
                row.innerHTML = `
                    <td>${userName}</td>
                    <td>${txn.type}</td>
                    <td>
                        <strong style="color: ${txn.amount >= 0 ? '#28a745' : '#dc3545'}">
                            $${txn.amount}
                        </strong>
                    </td>
                    <td>${txn.description || 'N/A'}</td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge status-${txn.status}">
                            ${txn.status}
                        </span>
                    </td>
                `;
            });
        }
        
        // ==============================================
        // LOAD WITHDRAWALS (NO INDEX ERRORS)
        // ==============================================
        async function loadWithdrawals() {
            try {
                const tbody = document.getElementById('withdrawals-tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                // Method 1: Load all and filter (No index required)
                const snapshot = await db.collection('transactions').get();
                
                allWithdrawals = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'withdrawal') {
                        allWithdrawals.push({ id: doc.id, ...data });
                    }
                });
                
                // Sort by date manually
                allWithdrawals.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date) : new Date(0);
                    const dateB = b.date ? new Date(b.date) : new Date(0);
                    return dateB - dateA; // Descending
                });
                
                updateWithdrawalsTable();
                
            } catch (error) {
                console.error("Error loading withdrawals:", error);
                const tbody = document.getElementById('withdrawals-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-money-bill-wave"></i><br>
                                No withdrawal requests found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateWithdrawalsTable() {
            const tbody = document.getElementById('withdrawals-tbody');
            tbody.innerHTML = '';
            
            if (allWithdrawals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-money-bill-wave"></i><br>
                                No withdrawal requests found
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('withdrawals-count').textContent = '0 withdrawals';
                return;
            }
            
            document.getElementById('withdrawals-count').textContent = `${allWithdrawals.length} withdrawals`;
            
            allWithdrawals.forEach(withdrawal => {
                const row = tbody.insertRow();
                const date = withdrawal.date ? new Date(withdrawal.date).toLocaleString() : 'N/A';
                const user = allUsers.find(u => u.id === withdrawal.userId);
                const userName = user ? user.name : 'Unknown User';
                
                row.innerHTML = `
                    <td>${userName}</td>
                    <td><strong>$${withdrawal.amount}</strong></td>
                    <td>${withdrawal.method || 'N/A'}</td>
                    <td style="max-width: 150px; word-break: break-all;">
                        <small>${withdrawal.wallet || 'N/A'}</small>
                    </td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge status-${withdrawal.status}">
                            ${withdrawal.status}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn activate-btn" onclick="approveWithdrawal('${withdrawal.id}')" 
                                ${withdrawal.status === 'completed' ? 'disabled' : ''} title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="rejectWithdrawal('${withdrawal.id}')"
                                ${withdrawal.status === 'rejected' ? 'disabled' : ''} title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="action-btn edit-btn" onclick="createTransactionForWithdrawal('${withdrawal.id}')" title="Create Message">
                            <i class="fas fa-comment"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        // Function to create transaction for a specific withdrawal
        function createTransactionForWithdrawal(withdrawalId) {
            const withdrawal = allWithdrawals.find(w => w.id === withdrawalId);
            if (!withdrawal) return;
            
            const user = allUsers.find(u => u.id === withdrawal.userId);
            if (!user) return;
            
            // Populate user dropdown
            const userSelect = document.getElementById('transaction-user');
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            
            allUsers.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.name} (${u.email}) - Balance: $${(u.balance || 0).toFixed(2)}`;
                option.selected = u.id === user.id;
                userSelect.appendChild(option);
            });
            
            // Pre-fill form with withdrawal details
            document.getElementById('transaction-type').value = 'withdrawal';
            document.getElementById('transaction-amount').value = withdrawal.amount;
            document.getElementById('transaction-description').value = `Withdrawal processed: ${withdrawal.method || ''}. ${withdrawal.wallet ? `Wallet: ${withdrawal.wallet}` : ''}`;
            document.getElementById('transaction-status').value = withdrawal.status === 'completed' ? 'completed' : 'pending';
            
            // Update user info
            updateUserInfo();
            
            showModal('create-transaction-modal');
        }
        
        async function approveWithdrawal(transactionId) {
            if (confirm('Approve this withdrawal request?')) {
                try {
                    const withdrawal = allWithdrawals.find(w => w.id === transactionId);
                    if (!withdrawal) return;
                    
                    // Get withdrawal fee from settings
                    let withdrawalFee = 5; // Default
                    try {
                        const settingsDoc = await db.collection('settings').doc('system').get();
                        if (settingsDoc.exists) {
                            withdrawalFee = settingsDoc.data().withdrawalFee || 5;
                        }
                    } catch (error) {
                        console.error("Error getting withdrawal fee from settings:", error);
                    }
                    
                    // Calculate fee based on settings
                    const fee = withdrawal.amount * (withdrawalFee / 100);
                    const netAmount = withdrawal.amount - fee;
                    
                    // Update transaction status
                    await db.collection('transactions').doc(transactionId).update({
                        status: 'completed',
                        netAmount: netAmount,
                        fee: fee,
                        processedAt: new Date().toISOString(),
                        processedBy: 'admin'
                    });
                    
                    // Update user balance
                    const user = allUsers.find(u => u.id === withdrawal.userId);
                    if (user) {
                        const newBalance = (user.balance || 0) - withdrawal.amount;
                        await db.collection('users').doc(withdrawal.userId).update({
                            balance: newBalance
                        });
                    }
                    
                    alert(`Withdrawal approved! Fee: $${fee.toFixed(2)} (${withdrawalFee}%), Net: $${netAmount.toFixed(2)}`);
                    loadWithdrawals();
                    loadUsers();
                    loadDashboardStats();
                    
                } catch (error) {
                    console.error("Error approving withdrawal:", error);
                    alert('Error approving withdrawal: ' + error.message);
                }
            }
        }
        
        async function rejectWithdrawal(transactionId) {
            if (confirm('Reject this withdrawal request?')) {
                try {
                    await db.collection('transactions').doc(transactionId).update({
                        status: 'rejected',
                        processedAt: new Date().toISOString(),
                        processedBy: 'admin'
                    });
                    
                    alert('Withdrawal rejected!');
                    loadWithdrawals();
                    
                } catch (error) {
                    console.error("Error rejecting withdrawal:", error);
                    alert('Error rejecting withdrawal: ' + error.message);
                }
            }
        }
        
        // ==============================================
        // LOAD INVESTMENTS (NO INDEX ERRORS)
        // ==============================================
        async function loadInvestments() {
            try {
                const tbody = document.getElementById('investments-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                // Method 1: Load all and filter (No index required)
                const snapshot = await db.collection('transactions').get();
                
                allInvestments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'investment') {
                        allInvestments.push({ id: doc.id, ...data });
                    }
                });
                
                // Sort by date manually
                allInvestments.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date) : new Date(0);
                    const dateB = b.date ? new Date(b.date) : new Date(0);
                    return dateB - dateA; // Descending
                });
                
                updateInvestmentsTable();
                
            } catch (error) {
                console.error("Error loading investments:", error);
                const tbody = document.getElementById('investments-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-chart-line"></i><br>
                                No investment requests found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateInvestmentsTable() {
            const tbody = document.getElementById('investments-tbody');
            tbody.innerHTML = '';
            
            if (allInvestments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-chart-line"></i><br>
                                No investment requests found
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('investments-count').textContent = '0 investments';
                return;
            }
            
            document.getElementById('investments-count').textContent = `${allInvestments.length} investments`;
            
            allInvestments.forEach(investment => {
                const row = tbody.insertRow();
                const date = investment.date ? new Date(investment.date).toLocaleString() : 'N/A';
                const user = allUsers.find(u => u.id === investment.userId);
                const userName = user ? user.name : 'Unknown User';
                
                row.innerHTML = `
                    <td>${userName}</td>
                    <td>${investment.plan || 'N/A'}</td>
                    <td><strong>$${investment.amount}</strong></td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge status-${investment.status}">
                            ${investment.status}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn activate-btn" onclick="approveInvestment('${investment.id}')"
                                ${investment.status === 'completed' ? 'disabled' : ''} title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="rejectInvestment('${investment.id}')"
                                ${investment.status === 'rejected' ? 'disabled' : ''} title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        async function approveInvestment(transactionId) {
            if (confirm('Approve this investment request?')) {
                try {
                    await db.collection('transactions').doc(transactionId).update({
                        status: 'completed',
                        processedAt: new Date().toISOString(),
                        processedBy: 'admin'
                    });
                    
                    alert('Investment approved!');
                    loadInvestments();
                    
                } catch (error) {
                    console.error("Error approving investment:", error);
                    alert('Error approving investment: ' + error.message);
                }
            }
        }
        
        async function rejectInvestment(transactionId) {
            if (confirm('Reject this investment request?')) {
                try {
                    await db.collection('transactions').doc(transactionId).update({
                        status: 'rejected',
                        processedAt: new Date().toISOString(),
                        processedBy: 'admin'
                    });
                    
                    alert('Investment rejected!');
                    loadInvestments();
                    
                } catch (error) {
                    console.error("Error rejecting investment:", error);
                    alert('Error rejecting investment: ' + error.message);
                }
            }
        }
        
        // ==============================================
        // COMMENT MANAGEMENT - NEW FUNCTIONS
        // ==============================================
        async function loadComments() {
            try {
                const tbody = document.getElementById('comments-tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;"><div class="loader"></div></td></tr>';
                
                const snapshot = await db.collection('comments').orderBy('timestamp', 'desc').get();
                allComments = [];
                snapshot.forEach(doc => {
                    allComments.push({ 
                        id: doc.id, 
                        ...doc.data(),
                        timestamp: doc.data().timestamp || new Date().toISOString()
                    });
                });
                
                updateCommentStats();
                filterComments(currentFilter);
                
            } catch (error) {
                console.error("Error loading comments:", error);
                const tbody = document.getElementById('comments-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i><br>
                                No comments found
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateCommentStats() {
            if (allComments.length === 0) {
                document.getElementById('total-comments-stat').textContent = '0';
                document.getElementById('pending-comments-stat').textContent = '0';
                document.getElementById('approved-comments-stat').textContent = '0';
                document.getElementById('rejected-comments-stat').textContent = '0';
                document.getElementById('comments-count').textContent = '0 comments';
                return;
            }
            
            const total = allComments.length;
            const pending = allComments.filter(c => c.status === 'pending').length;
            const approved = allComments.filter(c => c.status === 'approved').length;
            const rejected = allComments.filter(c => c.status === 'rejected').length;
            
            document.getElementById('total-comments-stat').textContent = total;
            document.getElementById('pending-comments-stat').textContent = pending;
            document.getElementById('approved-comments-stat').textContent = approved;
            document.getElementById('rejected-comments-stat').textContent = rejected;
            document.getElementById('comments-count').textContent = `${total} comments`;
        }
        
        function filterComments(filterType) {
            currentFilter = filterType;
            
            // Update filter buttons
            document.querySelectorAll('.comment-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter comments
            switch(filterType) {
                case 'all':
                    filteredComments = [...allComments];
                    break;
                case 'pending':
                    filteredComments = allComments.filter(c => c.status === 'pending');
                    break;
                case 'approved':
                    filteredComments = allComments.filter(c => c.status === 'approved');
                    break;
                case 'rejected':
                    filteredComments = allComments.filter(c => c.status === 'rejected');
                    break;
                case 'public':
                    filteredComments = allComments.filter(c => c.isPublic === true);
                    break;
                case 'private':
                    filteredComments = allComments.filter(c => c.isPublic === false);
                    break;
                default:
                    filteredComments = [...allComments];
            }
            
            updateCommentsTable();
        }
        
        function updateCommentsTable() {
            const tbody = document.getElementById('comments-tbody');
            tbody.innerHTML = '';
            selectedCommentIds.clear();
            document.getElementById('select-all-checkbox').checked = false;
            
            if (filteredComments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i><br>
                                No comments found
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredComments.forEach(comment => {
                const row = tbody.insertRow();
                row.className = 'comment-row';
                
                const date = comment.timestamp ? new Date(comment.timestamp).toLocaleString() : 'N/A';
                const status = comment.status || 'pending';
                const isPublic = comment.isPublic === true ? 'Public' : 'Private';
                
                let statusClass = 'status-pending';
                switch(status) {
                    case 'approved':
                        statusClass = 'status-active';
                        break;
                    case 'rejected':
                        statusClass = 'status-suspended';
                        break;
                }
                
                const commentPreview = comment.content ? 
                    (comment.content.length > 100 ? comment.content.substring(0, 100) + '...' : comment.content) : 
                    'No content';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="comment-checkbox" onchange="toggleCommentSelection('${comment.id}', this)">
                    </td>
                    <td>
                        <div>
                            <strong>${comment.userName || 'Anonymous'}</strong><br>
                            <small style="color: #666;">${comment.userEmail || 'No email'}</small>
                        </div>
                    </td>
                    <td class="comment-content-cell" title="${escapeHtml(comment.content || '')}">
                        ${escapeHtml(commentPreview)}
                    </td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${isPublic === 'Public' ? 'status-active' : 'status-inactive'}">
                            ${isPublic}
                        </span>
                    </td>
                    <td>
                        <div class="comment-actions">
                            <button class="action-btn view-comment-btn" onclick="viewCommentDetails('${comment.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${status !== 'approved' ? `
                            <button class="action-btn activate-btn" onclick="approveComment('${comment.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                            ${status !== 'rejected' ? `
                            <button class="action-btn suspend-btn" onclick="rejectComment('${comment.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                            <button class="action-btn delete-btn" onclick="deleteCommentPrompt('${comment.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }
        
        function toggleCommentSelection(commentId, checkbox) {
            if (checkbox.checked) {
                selectedCommentIds.add(commentId);
                checkbox.closest('tr').classList.add('selected');
            } else {
                selectedCommentIds.delete(commentId);
                checkbox.closest('tr').classList.remove('selected');
            }
        }
        
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.comment-checkbox');
            
            if (selectAllCheckbox.checked) {
                selectedCommentIds.clear();
                filteredComments.forEach(comment => {
                    selectedCommentIds.add(comment.id);
                });
                checkboxes.forEach(cb => cb.checked = true);
                document.querySelectorAll('.comment-row').forEach(row => row.classList.add('selected'));
            } else {
                selectedCommentIds.clear();
                checkboxes.forEach(cb => cb.checked = false);
                document.querySelectorAll('.comment-row').forEach(row => row.classList.remove('selected'));
            }
        }
        
        function selectAllComments() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            selectAllCheckbox.checked = true;
            toggleSelectAll();
        }
        
        async function bulkApproveComments() {
            if (selectedCommentIds.size === 0) {
                alert('Please select comments to approve');
                return;
            }
            
            if (!confirm(`Approve ${selectedCommentIds.size} selected comment(s)?`)) {
                return;
            }
            
            try {
                const updatePromises = [];
                
                selectedCommentIds.forEach(commentId => {
                    const commentRef = db.collection('comments').doc(commentId);
                    updatePromises.push(commentRef.update({
                        status: 'approved',
                        reviewed: true,
                        reviewedBy: 'admin',
                        reviewedAt: new Date().toISOString()
                    }));
                });
                
                await Promise.all(updatePromises);
                
                alert(`Successfully approved ${selectedCommentIds.size} comment(s)!`);
                selectedCommentIds.clear();
                document.getElementById('select-all-checkbox').checked = false;
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error bulk approving comments:", error);
                alert('Error approving comments: ' + error.message);
            }
        }
        
        async function bulkRejectComments() {
            if (selectedCommentIds.size === 0) {
                alert('Please select comments to reject');
                return;
            }
            
            if (!confirm(`Reject ${selectedCommentIds.size} selected comment(s)?`)) {
                return;
            }
            
            try {
                const updatePromises = [];
                
                selectedCommentIds.forEach(commentId => {
                    const commentRef = db.collection('comments').doc(commentId);
                    updatePromises.push(commentRef.update({
                        status: 'rejected',
                        reviewed: true,
                        reviewedBy: 'admin',
                        reviewedAt: new Date().toISOString()
                    }));
                });
                
                await Promise.all(updatePromises);
                
                alert(`Successfully rejected ${selectedCommentIds.size} comment(s)!`);
                selectedCommentIds.clear();
                document.getElementById('select-all-checkbox').checked = false;
                loadComments();
                
            } catch (error) {
                console.error("Error bulk rejecting comments:", error);
                alert('Error rejecting comments: ' + error.message);
            }
        }
        
        function bulkDeleteComments() {
            if (selectedCommentIds.size === 0) {
                alert('Please select comments to delete');
                return;
            }
            
            commentsToDelete = Array.from(selectedCommentIds);
            document.getElementById('delete-comments-count').textContent = commentsToDelete.length;
            showModal('delete-comments-modal');
            document.getElementById('delete-comments-password').value = '';
        }
        
        async function confirmDeleteComments() {
            const password = document.getElementById('delete-comments-password').value;
            
            if (password !== ADMIN_PASSWORD) {
                alert('Invalid admin password!');
                return;
            }
            
            if (commentsToDelete.length === 0) {
                alert('No comments selected for deletion');
                return;
            }
            
            if (!confirm(`Are you sure you want to permanently delete ${commentsToDelete.length} comment(s)? This action cannot be undone!`)) {
                return;
            }
            
            try {
                const deletePromises = commentsToDelete.map(commentId => 
                    db.collection('comments').doc(commentId).delete()
                );
                
                await Promise.all(deletePromises);
                
                alert(`Successfully deleted ${commentsToDelete.length} comment(s)!`);
                closeModal('delete-comments-modal');
                selectedCommentIds.clear();
                document.getElementById('select-all-checkbox').checked = false;
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error bulk deleting comments:", error);
                alert('Error deleting comments: ' + error.message);
            }
        }
        
        function viewCommentDetails(commentId) {
            currentCommentId = commentId;
            const comment = allComments.find(c => c.id === commentId);
            if (!comment) return;
            
            const detailsContent = document.getElementById('comment-details-content');
            const metaInfo = document.getElementById('comment-meta-info');
            
            // Format comment content
            detailsContent.innerHTML = `
                <h4 style="color: #6ab8ff; margin-bottom: 10px;">Comment Content:</h4>
                <p style="white-space: pre-wrap; background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 5px;">
                    ${escapeHtml(comment.content || 'No content')}
                </p>
            `;
            
            // Format meta information
            const date = comment.timestamp ? new Date(comment.timestamp).toLocaleString() : 'N/A';
            const reviewedDate = comment.reviewedAt ? new Date(comment.reviewedAt).toLocaleString() : 'Not reviewed';
            const status = comment.status || 'pending';
            const isPublic = comment.isPublic === true ? 'Public' : 'Private';
            const allowPost = comment.allowPost === true ? 'Yes' : 'No';
            const likesCount = comment.likesCount || 0;
            
            metaInfo.innerHTML = `
                <div class="meta-item">
                    <div class="meta-label">User Name</div>
                    <div class="meta-value">${comment.userName || 'Anonymous'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">User Email</div>
                    <div class="meta-value">${comment.userEmail || 'No email'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Submitted Date</div>
                    <div class="meta-value">${date}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Status</div>
                    <div class="meta-value">
                        <span class="status-badge ${status === 'approved' ? 'status-active' : status === 'rejected' ? 'status-suspended' : 'status-pending'}">
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Visibility</div>
                    <div class="meta-value">${isPublic}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Post Allowed</div>
                    <div class="meta-value">${allowPost}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Likes Count</div>
                    <div class="meta-value">${likesCount}</div>
                </div>
                ${comment.reviewed ? `
                <div class="meta-item">
                    <div class="meta-label">Reviewed By</div>
                    <div class="meta-value">${comment.reviewedBy || 'Admin'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Reviewed Date</div>
                    <div class="meta-value">${reviewedDate}</div>
                </div>` : ''}
            `;
            
            showModal('view-comment-modal');
        }
        
        async function approveCurrentComment() {
            if (!currentCommentId) return;
            
            try {
                await db.collection('comments').doc(currentCommentId).update({
                    status: 'approved',
                    reviewed: true,
                    reviewedBy: 'admin',
                    reviewedAt: new Date().toISOString()
                });
                
                alert('Comment approved successfully!');
                closeModal('view-comment-modal');
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error approving comment:", error);
                alert('Error approving comment: ' + error.message);
            }
        }
        
        async function rejectCurrentComment() {
            if (!currentCommentId) return;
            
            try {
                await db.collection('comments').doc(currentCommentId).update({
                    status: 'rejected',
                    reviewed: true,
                    reviewedBy: 'admin',
                    reviewedAt: new Date().toISOString()
                });
                
                alert('Comment rejected successfully!');
                closeModal('view-comment-modal');
                loadComments();
                
            } catch (error) {
                console.error("Error rejecting comment:", error);
                alert('Error rejecting comment: ' + error.message);
            }
        }
        
        async function deleteCurrentComment() {
            if (!currentCommentId) return;
            
            if (!confirm('Are you sure you want to delete this comment? This action cannot be undone!')) {
                return;
            }
            
            const password = prompt('Enter admin password to confirm:');
            if (password !== ADMIN_PASSWORD) {
                alert('Invalid admin password!');
                return;
            }
            
            try {
                await db.collection('comments').doc(currentCommentId).delete();
                
                alert('Comment deleted successfully!');
                closeModal('view-comment-modal');
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error deleting comment:", error);
                alert('Error deleting comment: ' + error.message);
            }
        }
        
        async function approveComment(commentId) {
            if (!confirm('Approve this comment?')) return;
            
            try {
                await db.collection('comments').doc(commentId).update({
                    status: 'approved',
                    reviewed: true,
                    reviewedBy: 'admin',
                    reviewedAt: new Date().toISOString()
                });
                
                alert('Comment approved successfully!');
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error approving comment:", error);
                alert('Error approving comment: ' + error.message);
            }
        }
        
        async function rejectComment(commentId) {
            if (!confirm('Reject this comment?')) return;
            
            try {
                await db.collection('comments').doc(commentId).update({
                    status: 'rejected',
                    reviewed: true,
                    reviewedBy: 'admin',
                    reviewedAt: new Date().toISOString()
                });
                
                alert('Comment rejected successfully!');
                loadComments();
                
            } catch (error) {
                console.error("Error rejecting comment:", error);
                alert('Error rejecting comment: ' + error.message);
            }
        }
        
        function deleteCommentPrompt(commentId) {
            if (!confirm('Delete this comment?')) return;
            
            const password = prompt('Enter admin password to confirm:');
            if (password !== ADMIN_PASSWORD) {
                alert('Invalid admin password!');
                return;
            }
            
            deleteComment(commentId);
        }
        
        async function deleteComment(commentId) {
            try {
                await db.collection('comments').doc(commentId).delete();
                
                alert('Comment deleted successfully!');
                loadComments();
                loadDashboardStats();
                
            } catch (error) {
                console.error("Error deleting comment:", error);
                alert('Error deleting comment: ' + error.message);
            }
        }
        
        // ==============================================
        // SEARCH FUNCTIONALITY
        // ==============================================
        function searchTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const activeTab = document.querySelector('.tab-content.active').id;
            
            switch(activeTab) {
                case 'users-tab':
                    searchUsers(searchTerm);
                    break;
                case 'comments-tab':
                    searchComments(searchTerm);
                    break;
                case 'referrals-tab':
                    searchReferrals(searchTerm);
                    break;
                case 'transactions-tab':
                    searchTransactions(searchTerm);
                    break;
                case 'withdrawals-tab':
                    searchWithdrawals(searchTerm);
                    break;
                case 'investments-tab':
                    searchInvestments(searchTerm);
                    break;
            }
        }
        
        function searchUsers(term) {
            const tbody = document.getElementById('users-tbody');
            if (!term) {
                updateUsersTable();
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                (user.name && user.name.toLowerCase().includes(term)) ||
                (user.email && user.email.toLowerCase().includes(term)) ||
                (user.phone && user.phone.includes(term)) ||
                (user.referralCode && user.referralCode.toLowerCase().includes(term)) ||
                (user.id && user.id.toLowerCase().includes(term))
            );
            
            tbody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-search"></i><br>
                                No users found matching "${term}"
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const row = tbody.insertRow();
                row.className = 'user-row';
                const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                const profilePic = user.profilePictureUrl || 'ol3.png';
                
                // Add long press event listeners
                row.addEventListener('touchstart', function(e) {
                    longPressTimer = setTimeout(() => {
                        showUserDetails(user.id);
                        this.classList.add('long-press-active');
                    }, LONG_PRESS_DURATION);
                });
                
                row.addEventListener('touchend', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.addEventListener('touchmove', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                // For desktop
                row.addEventListener('mousedown', function(e) {
                    longPressTimer = setTimeout(() => {
                        showUserDetails(user.id);
                        this.classList.add('long-press-active');
                    }, LONG_PRESS_DURATION);
                });
                
                row.addEventListener('mouseup', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.addEventListener('mouseleave', function(e) {
                    clearTimeout(longPressTimer);
                    this.classList.remove('long-press-active');
                });
                
                row.innerHTML = `
                    <td>
                        <img src="${profilePic}" class="profile-pic-small" alt="${user.name}" onerror="this.src='ol3.png'">
                    </td>
                    <td>
                        <strong>${user.name || 'N/A'}</strong><br>
                        <small style="color: #666;">${user.phone || 'No phone'}</small>
                    </td>
                    <td>${user.email || 'N/A'}</td>
                    <td>
                        <strong style="color: #6ab8ff;">$${(user.balance || 0).toFixed(2)}</strong>
                    </td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                            ${user.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <code style="color: #6ab8ff; background: rgba(106, 184, 255, 0.1); padding: 3px 6px; border-radius: 3px;">
                            ${user.referralCode || 'N/A'}
                        </code>
                    </td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${user.isActive ? 'suspend-btn' : 'activate-btn'}" 
                                onclick="${user.isActive ? 'suspendUser' : 'activateUser'}('${user.id}')">
                            <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteUserPrompt('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function searchComments(term) {
            if (!term) {
                updateCommentsTable();
                return;
            }
            
            const searchResults = filteredComments.filter(comment => 
                (comment.userName && comment.userName.toLowerCase().includes(term)) ||
                (comment.userEmail && comment.userEmail.toLowerCase().includes(term)) ||
                (comment.content && comment.content.toLowerCase().includes(term)) ||
                (comment.status && comment.status.toLowerCase().includes(term))
            );
            
            const tbody = document.getElementById('comments-tbody');
            tbody.innerHTML = '';
            
            if (searchResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-search"></i><br>
                                No comments found matching "${term}"
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            searchResults.forEach(comment => {
                const row = tbody.insertRow();
                row.className = 'comment-row';
                
                const date = comment.timestamp ? new Date(comment.timestamp).toLocaleString() : 'N/A';
                const status = comment.status || 'pending';
                const isPublic = comment.isPublic === true ? 'Public' : 'Private';
                
                let statusClass = 'status-pending';
                switch(status) {
                    case 'approved':
                        statusClass = 'status-active';
                        break;
                    case 'rejected':
                        statusClass = 'status-suspended';
                        break;
                }
                
                const commentPreview = comment.content ? 
                    (comment.content.length > 100 ? comment.content.substring(0, 100) + '...' : comment.content) : 
                    'No content';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="comment-checkbox" onchange="toggleCommentSelection('${comment.id}', this)">
                    </td>
                    <td>
                        <div>
                            <strong>${comment.userName || 'Anonymous'}</strong><br>
                            <small style="color: #666;">${comment.userEmail || 'No email'}</small>
                        </div>
                    </td>
                    <td class="comment-content-cell" title="${escapeHtml(comment.content || '')}">
                        ${escapeHtml(commentPreview)}
                    </td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${isPublic === 'Public' ? 'status-active' : 'status-inactive'}">
                            ${isPublic}
                        </span>
                    </td>
                    <td>
                        <div class="comment-actions">
                            <button class="action-btn view-comment-btn" onclick="viewCommentDetails('${comment.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${status !== 'approved' ? `
                            <button class="action-btn activate-btn" onclick="approveComment('${comment.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                            ${status !== 'rejected' ? `
                            <button class="action-btn suspend-btn" onclick="rejectComment('${comment.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                            <button class="action-btn delete-btn" onclick="deleteCommentPrompt('${comment.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }
        
        function searchReferrals(term) {
            const tbody = document.getElementById('referrals-tbody');
            if (!term) {
                updateReferralsTable();
                return;
            }
            
            const filteredReferrals = allReferrals.filter(referral => 
                (referral.userName && referral.userName.toLowerCase().includes(term)) ||
                (referral.userEmail && referral.userEmail.toLowerCase().includes(term)) ||
                (referral.referredBy && referral.referredBy.toLowerCase().includes(term)) ||
                (referral.referralCode && referral.referralCode.toLowerCase().includes(term))
            );
            
            tbody.innerHTML = '';
            
            if (filteredReferrals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ccc;">
                            <div class="no-data">
                                <i class="fas fa-search"></i><br>
                                No referrals found matching "${term}"
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredReferrals.forEach(referral => {
                const row = tbody.insertRow();
                const date = referral.createdAt ? new Date(referral.createdAt).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>
                        <img src="${referral.userProfilePic}" class="profile-pic-small" alt="${referral.userName}" onerror="this.src='ol3.png'">
                    </td>
                    <td>
                        <strong>${referral.userName || 'N/A'}</strong><br>
                        <small style="color: #666;">${referral.userEmail || 'No email'}</small>
                    </td>
                    <td>${referral.referredBy || 'N/A'}</td>
                    <td><code>${referral.referralCode || 'N/A'}</code></td>
                    <td><small>${date}</small></td>
                    <td>
                        <span class="status-badge status-pending">
                            Pending
                        </span>
                    </td>
                    <td>
                        <button class="action-btn activate-btn" onclick="approveReferral('${referral.id}')" title="Approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="action-btn delete-btn" onclick="rejectReferral('${referral.id}')" title="Reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                `;
            });
        }
        
        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showErrorMessage(element, message) {
            if (element) {
                element.textContent = message;
                element.className = 'message error';
                element.style.display = 'block';
            } else {
                alert('Error: ' + message);
            }
        }
        
        function showSuccessMessage(element, message) {
            if (element) {
                element.textContent = message;
                element.className = 'message success';
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            } else { 
                // Do nothing
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
